{
"version":"1.0",
"description":"Read UNALIGNED data in BAM format producing output in CRAM format. Uses Biobambam2",
"subst_params":[
	{
		"id":"basic_pipeline_params_file",
		"required":"yes",
		"subst_constructor":{ "vals":[ {"subst":"cfgdatadir"}, "/", "alignment_common.json" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id": "basic_pipeline_params",
		"type":"SPFILE",
		"name":{"subst":"basic_pipeline_params_file"},
		"required": "no",
		"comment":"this will expand to a set of subst_param elements"
	},
	{
		"id":"target_indicator",
		"default":""
	},
	{
		"id":"phix_indicator",
		"default":"_phix"
	},
	{
		"id":"phix_or_target",
		"default":{"subst":"target_indicator"}
	},
	{
		"id":"bs_tmpfile_flag",
		"required":"no",
		"subst_constructor":{ "vals":[ "tmpfile=", {"subst":"outdatadir"}, "/", "bsfopt", "_", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".tmp" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"scramble_reference_flag",
		"required":"no",
		"comment":"flag will disappear unless scramble_reference_fasta value is given (allows unaligned cram)",
		"subst_constructor":{ "vals":[ "-r", {"subst":"scramble_reference_fasta"} ] }
	},
	{
		"id":"bmd_tmpfile_flag",
		"required":"no",
		"subst_constructor":{ "vals":[ "tmpfile=", {"subst":"outdatadir"}, "/", "bmdfopt", "_", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".tmp" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"bmd_metrics_file_flag",
		"required":"no",
		"subst_constructor":{ "vals":[ "M=", {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".markdups_metrics.txt" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"src_bam",
		"required":"yes",
		"subst_constructor":{ "vals":[ {"subst":"indatadir"}, "/", {"subst":"rpt"}, ".bam" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"bmd_cmd",
		"required":"no",
		"default":"bamstreamingmarkduplicates"
	},
	{
		"id":"stats_filter__F0x900",
		"required":"no",
		"default":"0x900"
	},
	{
		"id":"stats_filter__F0xB00",
		"required":"no",
		"default":"0xB00"
	},
	{
		"id":"calibration_pu_executable",
		"required":"no",
		"default":"calibration_pu"
	},
	{
		"id":"calibration_pu_bad_tiles_count",
		"required":"no",
		"default":"2"
	},
	{
		"id":"calibration_pu_prefix",
		"required":"yes",
		"subst_constructor":{ "vals":[ {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"} ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"seqchksum_hash_type",
		"required":"no",
		"default":"sha512primesums512"
	},
	{
		"id":"seqchksum_hash_flag",
		"required":"yes",
		"subst_constructor":{ "vals":[ "hash", {"subst":"seqchksum_hash_type"} ], "postproc":{"op":"concat","pad":"="} }
	},
	{
		"id":"br_indexfile_flag",
		"required":"no",
		"subst_constructor":{ "vals":[ "indexfilename=", {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".bai" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"br_md5file_flag",
		"required":"no",
		"subst_constructor":{ "vals":[ "md5filename=", {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".bam.md5" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"br_numthreads_flag",
		"required":"no",
		"subst_constructor":{ "vals":[ "numthreads=", {"subst":"br_numthreads_val"} ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"br_tmpfile_flag",
		"required":"no",
		"subst_constructor":{ "vals":[ "tmpfile=", {"subst":"outdatadir"}, "/", {"subst":"brtmp"}, "_", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".tmp" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"flagstats_filter_flag",
		"required":"no",
		"default":"0x900"
	},
	{
		"id":"cram_file",
		"subst_constructor":{ "vals":[ {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, {"subst":"cram_ext"} ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"crai_file",
		"subst_constructor":{ "vals":[ {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, {"subst":"cram_idx_ext"} ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"cram_md5",
		"subst_constructor":{ "vals":[ {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".cram.md5" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"seqchksum_file",
		"required":"yes",
		"subst_constructor":{ "vals":[ {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".seqchksum" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"seqchksum_file_cram",
		"required":"yes",
		"subst_constructor":{ "vals":[ {"subst":"tmpdir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".cram.seqchksum" ], "postproc":{"op":"concat", "pad":""} },
		"comment":"this temporary file is used for removing blocking problems at cmp_seqchksum"
	},
	{
		"id":"seqchksum_extrahash_file_cram",
		"required":"yes",
		"subst_constructor":{ "vals":[ {"subst":"tmpdir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".", {"subst":"seqchksum_hash_type"}, ".cram.seqchksum" ], "postproc":{"op":"concat", "pad":""} },
		"comment":"this temporary file is used for removing blocking problems at cmp_seqchksum_extrahash"
	},
	{
		"id":"seqchksum_extrahash_file",
		"required":"yes",
		"subst_constructor":{ "vals":[ {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".", {"subst":"seqchksum_hash_type"}, ".seqchksum" ], "postproc":{"op":"concat", "pad":""} },
		"comment":"default hash type is currently sha512primesums512"
	},
	{
		"id":"bamcheck_file",
		"required":"yes",
		"subst_constructor":{ "vals":[ {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".bamcheck" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"stats_F0x900_file",
		"subst_constructor":{ "vals":[ {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, "_F0x900.stats" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"stats_F0xB00_file",
		"subst_constructor":{ "vals":[ {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, "_F0xB00.stats" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"flagstat_file",
		"required":"yes",
		"subst_constructor":{ "vals":[ {"subst":"outdatadir"}, "/", {"subst":"rpt"}, {"subst":"phix_or_target"}, ".flagstat" ], "postproc":{"op":"concat", "pad":""} }
	},
	{
		"id":"bsmd_threads",
		"subst_constructor":{ "vals":[ "threads", {"subst":"aligner_numthreads"} ], "postproc":{"op":"concat", "pad":"="} }
	},
	{"id":"filter_header_script","required":"no","default":"npg_fix_sam_header"}
],
"nodes":[
    {
		"id": "src_bam",
		"type": "INFILE",
		"name": {"subst":"src_bam"},
		"description": "BAM used as input to this pipeline - expected to already contain PhiX (normally from hyb buffer spike-in) alignments"
    },
    {
		"id":"sam_headerRGfix",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd": [ {"subst":"samtools_executable"}, "view", "-H", "-" ],
		"description": "convert BAM to SAM"
    },
    {
		"id":"alterRG_headerRGfix",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd": [ {"subst":"filter_header_script"}, "-rpt", {"subst": "rpt"} ],
		"description": "update RG line"
    },
    {
		"id":"reheader_headerRGfix",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd": [ {"subst":"samtools_executable"}, "reheader", "__IN_SAMHEADER__", "-" ],
		"description": "reheader SAM file"
    },
	{
		"id":"bmd_multiway",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": false,
		"comment":"specify parameter value teepot_tempdir_value to specify teepot tempdir",
		"cmd":[ "teepot", {"subst":"teepot_vflag", "ifnull":"-v"}, {"subst":"teepot_tempdir_flag"}, "-w", {"subst":"fomw_teepot_wval", "ifnull":"300"}, "__SCRAMBLE_OUT__", "__BAMCHECK_OUT__", "__FLAGSTAT_OUT__", "__CALIBRATION_PU_OUT__", "__SAMTOOLS_STATS_F0x900_OUT__", "__SAMTOOLS_STATS_F0xB00_OUT__", "__SEQCHKSUM_OUT__", "__SEQCHKSUM_EXTRAHASH_OUT__" ]
	},
	{
		"id":"scramble",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":[ "scramble", {"subst":"b2c_mt", "ifnull":{"subst_constructor":{ "vals":[ "-t", {"subst":"b2c_mt_val"} ]}}}, {"subst":"b2c_fmtver", "ifnull":{"subst_constructor":{ "vals":[ "-V", {"subst":"b2c_format_version"} ]}}}, {"subst":"b2c_compress_level", "ifnull":"-7"}, "-I", "bam", "-O", "cram", {"subst":"scramble_reference_flag"} ]
	},
	{
		"id":"scramble_tee",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": false,
		"cmd":[ "teepot", {"subst":"teepot_vflag", "ifnull":"-v"}, {"subst":"teepot_tempdir_flag"}, "-w", "30000", "__CRAM_OUT__", "__MD5_OUT__", "__SEQCHKSUM_OUT__", "__SEQCHKSUM_EXTRAHASH_OUT__" ],
		"comment":"allow a generous 500 minutes for the teepot timeout; specify parameter value teepot_tempdir_value to specify teepot tempdir"
	},
	{
		"id":"scramble_md5",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":"md5sum"
	},
	{
		"id":"postprocess_md5",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":[ "tr", "-d", " \\-\n" ],
		"comment":"the double-backslash is required to get the correct character set to the tr command"
	},
	{
		"id":"cram_seqchksum",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":[ "bamseqchksum", "inputformat=cram" ]
	},
	{
		"id":"bamcheck",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":[ "bamcheck", "-F", "0x900" ]
	},
	{
		"id":"samtools_stats_F0x900",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd": [ {"subst":"samtools_executable"}, "stats", "-F", {"subst":"stats_filter__F0x900"}, "-" ]
	},
	{
		"id":"samtools_stats_F0xB00",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd": [ {"subst":"samtools_executable"}, "stats", "-F", {"subst":"stats_filter__F0xB00"}, "-" ]
	},
	{
		"id":"seqchksum",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd":[ "bamseqchksum" ]
	},
	{
		"id":"seqchksum_extrahash",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd": [ "bamseqchksum", {"subst":"seqchksum_hash_flag"} ],
		"comment":"default hash type is currently sha512primesums512"
	},
	{
		"id":"cram_seqchksum_extrahash",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd": [ "bamseqchksum", {"subst":"seqchksum_hash_flag"}, "inputformat=cram" ],
		"comment":"default hash type is currently sha512primesums512"
	},
	{
		"id":"calibration_pu",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": false,
		"cmd": [ {"subst":"calibration_pu_executable"}, "-p", {"subst":"calibration_pu_prefix"}, "-filter-bad-tiles", {"subst":"calibration_pu_bad_tiles_count"}, "-" ]
	},
	{
		"id":"cram_file",
		"type":"OUTFILE",
		"name":{"subst":"cram_file"} 
	},
	{
		"id":"cram_md5", 
		"type":"OUTFILE",
		"name":{"subst":"cram_md5"}
	},
	{
		"id":"seqchksum_file",
		"type":"OUTFILE",
		"name":{"subst":"seqchksum_file"}
	},
	{
		"id":"seqchksum_file_cram",
		"type":"RAFILE",
		"name":{"subst":"seqchksum_file_cram"},
		"comment":"this file is a temporary fix for blocking problems at the cmp_seqchksum node"
	},
	{
		"id":"seqchksum_extrahash_file_cram",
		"type":"RAFILE",
		"name":{"subst":"seqchksum_extrahash_file_cram"},
		"comment":"this file is a temporary fix for blocking problems at the cmp_seqchksum_extrahash node"
	},
	{
		"id":"seqchksum_extrahash_file",
		"type":"OUTFILE",
		"name":{"subst":"seqchksum_extrahash_file"}
	},
	{
		"id":"bamcheck_file",
		"type":"OUTFILE",
		"name":{"subst":"bamcheck_file"}
	},
	{
		"id":"stats_F0x900_file",
		"type":"OUTFILE",
		"name":{"subst":"stats_F0x900_file"}
	},
	{
		"id":"stats_F0xB00_file",
		"type":"OUTFILE",
		"name":{"subst":"stats_F0xB00_file"}
	},
	{
		"id":"flagstat_file",
		"type":"OUTFILE",
		"name":{"subst":"flagstat_file"}
	},
	{
		"id":"flagstat_filter",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd": [ {"subst":"samtools_executable"}, "view", "-u", "-F", {"subst":"flagstats_filter_flag"}, "-" ],
		"description":"Filter out secondary and supplementary alignment records"
	},
	{
		"id":"flagstat",
		"type":"EXEC",
		"use_STDIN": true,
		"use_STDOUT": true,
		"cmd": [ {"subst":"samtools_executable"}, "flagstat", "-" ]
	},
	{
		"id":"cmp_seqchksum",
		"type":"EXEC",
		"use_STDIN": false,
		"use_STDOUT": true,
		"cmd":[ "cmp", "__BAM_SEQCHKSUM_IN__", "__CRAM_SEQCHKSUM_IN__" ]
	},
		{
		"id":"cmp_seqchksum_extrahash",
		"type":"EXEC",
		"use_STDIN": false,
		"use_STDOUT": true,
		"cmd":[ "cmp", "__BAM_SEQCHKSUM_EXTRAHASH_IN__", "__CRAM_SEQCHKSUM_EXTRAHASH_IN__" ]
	}
],
"edges":[
		{ "id":"src_to_sam_headerRGfix", "from": "src_bam", "to": "sam_headerRGfix" },
		{ "id":"src_to_sam_headerRGfix", "from": "src_bam", "to": "reheader_headerRGfix" },
		{ "id":"sam_headerRGfix_to_alterRG", "from":"sam_headerRGfix", "to":"alterRG_headerRGfix" },
		{ "id":"alterRG_headerRGfix_to_reheader", "from":"alterRG_headerRGfix", "to":"reheader_headerRGfix:__IN_SAMHEADER__" },
		{ "id":"reheader_to_bsortqname", "from":"reheader_headerRGfix", "to":"bmd_multiway" },
		{ "id":"bmdmw_to_scramble", "from":"bmd_multiway:__SCRAMBLE_OUT__", "to":"scramble" },
		{ "id":"scramble_to_scramble_tee", "from":"scramble", "to":"scramble_tee" },
		{ "id":"scramble_tee_to_md5", "from":"scramble_tee:__MD5_OUT__", "to":"scramble_md5" },
		{ "id":"scramble_tee_to_bscs", "from":"scramble_tee:__SEQCHKSUM_OUT__", "to":"cram_seqchksum" },
		{ "id":"scramble_tee_to_extrabscs", "from":"scramble_tee:__SEQCHKSUM_EXTRAHASH_OUT__", "to":"cram_seqchksum_extrahash" },
		{ "id":"md5_to_postprocess", "from":"scramble_md5", "to":"postprocess_md5" },
		{ "id":"bmdmw_to_bamcheck", "from":"bmd_multiway:__BAMCHECK_OUT__", "to":"bamcheck" },
		{ "id":"bmdmw_to_sts_F0x900", "from":"bmd_multiway:__SAMTOOLS_STATS_F0x900_OUT__", "to":"samtools_stats_F0x900" },
		{ "id":"bmdmw_to_sts_F0xB00", "from":"bmd_multiway:__SAMTOOLS_STATS_F0xB00_OUT__", "to":"samtools_stats_F0xB00" },
		{ "id":"bmdmw_to_calibration_pu", "from":"bmd_multiway:__CALIBRATION_PU_OUT__", "to":"calibration_pu" },
		{ "id":"bmdmw_to_seqchksum", "from":"bmd_multiway:__SEQCHKSUM_OUT__", "to":"seqchksum" },
		{ "id":"bmdmw_to_seqchksum_extrahash", "from":"bmd_multiway:__SEQCHKSUM_EXTRAHASH_OUT__", "to":"seqchksum_extrahash" },
		{ "id":"bmdmw_to_flagstat", "from":"bmd_multiway:__FLAGSTAT_OUT__", "to":"flagstat_filter" },
		{ "id":"flagstat_filter_to_flagstat", "from":"flagstat_filter", "to":"flagstat" },
		{ "id":"tee_to_cram", "from":"scramble_tee:__CRAM_OUT__", "to":"cram_file" },
		{ "id":"corrected_md5_out", "from":"postprocess_md5", "to":"cram_md5" },
		{ "id":"bamcheck_to_file", "from":"bamcheck", "to":"bamcheck_file" },
		{ "id":"scs_to_file", "from":"seqchksum", "to":"seqchksum_file" },
		{ "id":"scs_file_to_cmp", "from":"seqchksum_file", "to":"cmp_seqchksum:__BAM_SEQCHKSUM_IN__" },
		{ "id":"scs_extrahash_file_to_cmp_extrahash", "from":"seqchksum_extrahash_file", "to":"cmp_seqchksum_extrahash:__BAM_SEQCHKSUM_EXTRAHASH_IN__" },
		{ "id":"scs_extrahash_to_file", "from":"seqchksum_extrahash", "to":"seqchksum_extrahash_file" },
		{ "id":"samtools_stats_F0x900_to_file", "from":"samtools_stats_F0x900", "to":"stats_F0x900_file" },
		{ "id":"samtools_stats_F0xB00_to_file", "from":"samtools_stats_F0xB00", "to":"stats_F0xB00_file" },
		{ "id":"flagstat_to_file", "from":"flagstat", "to":"flagstat_file" },
		{ "id":"cscs_to_file", "from":"cram_seqchksum", "to":"seqchksum_file_cram" },
		{ "id":"cscseh_to_file", "from":"cram_seqchksum_extrahash", "to":"seqchksum_extrahash_file_cram" },
		{ "id":"cscsfile_to_cmp", "from":"seqchksum_file_cram", "to":"cmp_seqchksum:__CRAM_SEQCHKSUM_IN__" },
		{ "id":"cscsehfile_to_cmp", "from":"seqchksum_extrahash_file_cram", "to":"cmp_seqchksum_extrahash:__CRAM_SEQCHKSUM_EXTRAHASH_IN__" }
]
}
